<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Truck Reservations</title>

  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- FullCalendar -->
  <link href="https://unpkg.com/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body>
  <h1>Truck Reservations</h1>
<div class="header-actions">
  <button onclick="logout()">Log Out</button>
</div>

  <div class="container">
    <!-- Reservation Form -->
    <div class="sidebar">
      <h3>Reserve a Truck</h3>
      <label for="truck">Truck</label>
      <select id="truckList"></select>

      <label for="start">Start Time</label>
      <input type="datetime-local" id="start">

      <label for="end">End Time</label>
      <input type="datetime-local" id="end">

      <button onclick="reserveTruck()">Reserve</button>
      <p id="reserveMessage"></p>

      <h4>My Reservations</h4>
      <table>
        <thead>
          <tr>
            <th>Truck</th>
            <th>From</th>
            <th>To</th>
          </tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>

    <!-- Calendar -->
    <div class="calendar">
      <h3>Calendar View</h3>
      <div id="calendar"></div>
    </div>
  </div>

<script>
  const supabase = window.supabase.createClient(
    "https://nmbapqhtmjsqwdefewfd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tYmFwcWh0bWpzcXdkZWZld2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MTM3MzksImV4cCI6MjA2OTM4OTczOX0.TJmTwXT29jnbtu4Y4QvL0dlUsFFuOPiWsD7BzSOPUfM"
  );

  const userId = localStorage.getItem("user_id");
  const userName = localStorage.getItem("name");
  const userType = localStorage.getItem("user_type");

  if (!userId) {
    alert("You are not signed in.");
    window.location.href = "index.html";
  }

  // Load trucks into dropdown
  async function loadTrucks() {
    const truckList = document.getElementById("truckList");

    const { data, error } = await supabase
      .from("Trucks")
      .select("id, name");

    if (error) {
      console.error("Truck load error:", error);
      truckList.innerHTML = `<option>Error loading trucks</option>`;
      return;
    }

    truckList.innerHTML = data.map(truck =>
      `<option value="${truck.id}">${truck.name}</option>`
    ).join("");
  }

  // Reservation form submission with conflict prevention
  async function reserveTruck() {
    const truck_id = document.getElementById("truckList").value;
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;
    const userId = localStorage.getItem("user_id");
    const message = document.getElementById("reserveMessage");

    if (!truck_id || !start || !end) {
      message.innerText = "Please fill out all fields.";
      return;
    }

    // ðŸ” Check for conflicting reservations
    const { data: conflicts, error: conflictError } = await supabase
      .from("Reservations")
      .select("*, profiles(name)")
      .eq("truck_id", truck_id)
      .lte("start_time", end)
      .gte("end_time", start);

    if (conflictError) {
      console.error("Conflict check error:", conflictError);
      message.innerText = "Error checking availability.";
      return;
    }

    if (conflicts.length > 0) {
      const c = conflicts[0];
      const startTime = new Date(c.start_time).toLocaleString();
      const endTime = new Date(c.end_time).toLocaleString();
      message.innerHTML = `ðŸš« This truck is already reserved by <b>${c.profiles?.name || "another user"}</b><br>From <b>${startTime}</b> to <b>${endTime}</b>.`;
      return;
    }

    // ðŸ“ Insert reservation if available
    const { error } = await supabase.from("Reservations").insert({
      truck_id,
      user_id: userId,
      start_time: start,
      end_time: end
    });

    if (error) {
      message.innerText = "Reservation failed.";
      console.error("Insert failed:", error);
    } else {
      message.innerText = "âœ… Truck reserved!";
      loadCalendarTable();
      loadFullCalendar();
    }
  }

  // Populate reservation table (only current user)
  async function loadCalendarTable() {
    const userId = localStorage.getItem("user_id");

    const { data, error } = await supabase
      .from("Reservations")
      .select("*, Trucks(name), profiles(name)")
      .eq("user_id", userId)
      .order("start_time", { ascending: true });

    const table = document.getElementById("calendarBody");

    if (error) {
      console.error("Table load error:", error);
      return;
    }

    table.innerHTML = data.map(res => `
      <tr>
        <td>${res.Trucks.name}</td>
        <td>${new Date(res.start_time).toLocaleString()}</td>
        <td>${new Date(res.end_time).toLocaleString()}</td>
      </tr>
    `).join("");
  }

  // Load reservations into FullCalendar (only current user)
  async function loadFullCalendar() {
    const userId = localStorage.getItem("user_id");

    const { data, error } = await supabase
      .from("Reservations")
      .select("*, Trucks(name), profiles(name)")
      .eq("user_id", userId);

    if (error) {
      console.error("Calendar load error:", error);
      return;
    }

    const events = data.map(res => ({
      title: `${res.Trucks.name}`,
      start: res.start_time,
      end: res.end_time
    }));

    const calendarEl = document.getElementById("calendar");
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "timeGridWeek",
      height: "auto",
      events,
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      }
    });

    calendar.render();
  }

  // Logout function
  function logout() {
    localStorage.clear();
    window.location.href = "index.html";
  }

  // Init page
  loadTrucks();
  loadCalendarTable();
  loadFullCalendar();
</script>
</body>
</html>


