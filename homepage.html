<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gradex Scheduling</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <header class="header">
      <h1>Gradex Truck Scheduling</h1>
      <div id="user-info"></div>
      <button id="logout-btn">Logout</button>
    </header>

    <main>
      <section class="truck-section">
        <h2>Available Trucks</h2>
        <div id="truck-list"></div>
      </section>

      <section class="reservation-section">
        <h2>Your Reservations</h2>
        <table id="reservations-table">
          <thead>
            <tr>
              <th>Truck</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reservations-body"></tbody>
        </table>
      </section>
    </main>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const supabaseUrl = "https://nmbapqhtmjsqwdefewfd.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tYmFwcWh0bWpzcXdkZWZld2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MTM3MzksImV4cCI6MjA2OTM4OTczOX0.TJmTwXT29jnbtu4Y4QvL0dlUsFFuOPiWsD7BzSOPUfM";
      const supabase = createClient(supabaseUrl, supabaseKey);

      const userInfo = document.getElementById("user-info");
      const logoutBtn = document.getElementById("logout-btn");
      const truckList = document.getElementById("truck-list");
      const reservationsBody = document.getElementById("reservations-body");

      // ---------- Auth ----------
      const {
        data: { user },
        error,
      } = await supabase.auth.getUser();
      if (error || !user) {
        window.location.href = "index.html";
      } else {
        userInfo.textContent = `Signed in as: ${user.email}`;
      }

      logoutBtn.onclick = async () => {
        await supabase.auth.signOut();
        window.location.href = "index.html";
      };

      // ---------- Load trucks ----------
      async function loadTrucks() {
        const { data, error } = await supabase.from("Trucks").select("*");
        if (error) {
          console.error(error);
          return;
        }

        truckList.innerHTML = "";
        data.forEach((truck) => {
          const div = document.createElement("div");
          div.className = "truck-card";
          div.innerHTML = `
            <h3>${truck.name}</h3>
            <p>ID: ${truck.id}</p>
            <button onclick="reserveTruck('${truck.id}')">Reserve</button>
          `;
          truckList.appendChild(div);
        });
      }

      window.reserveTruck = async (truckId) => {
        const startTime = prompt("Enter start time (YYYY-MM-DD HH:MM)");
        const endTime = prompt("Enter end time (YYYY-MM-DD HH:MM)");
        if (!startTime || !endTime) return;

        // Check for overlap first
        const { data: conflicts, error: conflictError } = await supabase
          .from("Reservations")
          .select("*")
          .eq("truck_id", truckId)
          .or(
            `and(start_time.lte.${endTime},end_time.gte.${startTime})`
          );

        if (conflictError) {
          alert("Error checking conflicts.");
          console.error(conflictError);
          return;
        }

        if (conflicts && conflicts.length > 0) {
          alert(
            `Truck is already reserved during that time by ${conflicts[0].user_id}.`
          );
          return;
        }

        // Reserve the truck
        const { data, error } = await supabase
          .from("Reservations")
          .insert([
            {
              user_id: user.id,
              truck_id: truckId,
              start_time: startTime,
              end_time: endTime,
            },
          ])
          .select();

        if (error) {
          console.error("Insert failed:", error);
          alert("Reservation failed.");
          return;
        }

        alert("Reservation created successfully!");

        // âœ… Trigger Edge Function to send email
        try {
          const response = await fetch(
            "https://nmbapqhtmjsqwdefewfd.functions.supabase.co/send-reservation-email",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                record: {
                  user_id: user.id,
                  truck_id: truckId,
                  start_time: startTime,
                  end_time: endTime,
                },
              }),
            }
          );

          if (response.ok) {
            console.log("Email trigger succeeded.");
          } else {
            const txt = await response.text();
            console.error("Email trigger failed:", txt);
          }
        } catch (err) {
          console.error("Email function error:", err);
        }

        loadReservations();
      };

      // ---------- Load reservations ----------
      async function loadReservations() {
        const { data, error } = await supabase
          .from("Reservations")
          .select("*, Trucks(name)")
          .eq("user_id", user.id);

        if (error) {
          console.error(error);
          return;
        }

        reservationsBody.innerHTML = "";
        data.forEach((res) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${res.Trucks?.name || res.truck_id}</td>
            <td>${new Date(res.start_time).toLocaleString()}</td>
            <td>${new Date(res.end_time).toLocaleString()}</td>
            <td><button onclick="cancelReservation('${res.id}')">Cancel</button></td>
          `;
          reservationsBody.appendChild(tr);
        });
      }

      // ---------- Cancel reservation ----------
      window.cancelReservation = async (resId) => {
        if (!confirm("Cancel this reservation?")) return;
        const { error } = await supabase
          .from("Reservations")
          .delete()
          .eq("id", resId)
          .eq("user_id", user.id);
        if (error) console.error(error);
        loadReservations();
      };

      // ---------- Initial load ----------
      loadTrucks();
      loadReservations();
    </script>
  </body>
</html>
