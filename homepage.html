<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Truck Reservations</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://unpkg.com/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/fullcalendar@6.1.8/index.global.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script>
    // âœ… Initialize Supabase once
    const supabase = window.supabase.createClient(
      "https://nmbapqhtmjsqwdefewfd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tYmFwcWh0bWpzcXdkZWZld2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MTM3MzksImV4cCI6MjA2OTM4OTczOX0.TJmTwXT29jnbtu4Y4QvL0dlUsFFuOPiWsD7BzSOPUfM",
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      }
    );

    // âœ… Verify session before showing page
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        console.warn("No session found â†’ redirecting to sign in");
        window.location.href = "index.html";
        return;
      }
      console.log("Signed in as:", session.user.email);
    })();
  </script>
</head>

<body>
  <h1>Truck Reservations</h1>
  <div class="header-actions">
    <button onclick="logout()">Log Out</button>
  </div>

  <div class="container">
    <div class="sidebar">
      <h3>Reserve a Truck</h3>
      <label for="truck">Truck</label>
      <select id="truckList"></select>

      <label for="start">Start Time</label>
      <input type="datetime-local" id="start">

      <label for="end">End Time</label>
      <input type="datetime-local" id="end">

      <button onclick="reserveTruck()">Reserve</button>
      <p id="reserveMessage"></p>

      <h4>My Reservations</h4>
      <table>
        <thead>
          <tr><th>Truck</th><th>From</th><th>To</th></tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </div>

    <div class="calendar">
      <h3>Calendar View</h3>
      <div id="calendar"></div>
    </div>
  </div>

  <!-- âœ… All scripts at the bottom -->
  <script>
    // Load truck list
    async function loadTrucks() {
      const truckList = document.getElementById("truckList");
      const { data, error } = await supabase.from("Trucks").select("id, name");
      if (error) {
        console.error("Truck load error:", error);
        truckList.innerHTML = `<option>Error loading trucks</option>`;
        return;
      }
      truckList.innerHTML = data.map(t => `<option value="${t.id}">${t.name}</option>`).join("");
    }

    // Reserve truck
    async function reserveTruck() {
      const truck_id = document.getElementById("truckList").value;
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const message = document.getElementById("reserveMessage");

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        message.innerText = "You are not signed in.";
        window.location.href = "index.html";
        return;
      }
      const userId = session.user.id;

      if (!truck_id || !start || !end) {
        message.innerText = "Please fill out all fields.";
        return;
      }

      // Check conflicts
      const { data: conflicts, error: conflictError } = await supabase
        .from("Reservations")
        .select("*, profiles(name)")
        .eq("truck_id", truck_id)
        .lte("start_time", end)
        .gte("end_time", start);

      if (conflictError) {
        console.error("Conflict check error:", conflictError);
        message.innerText = "Error checking availability.";
        return;
      }

      if (conflicts.length > 0) {
        const c = conflicts[0];
        message.innerHTML = `ðŸš« Already reserved by <b>${c.profiles?.name || "another user"}</b>`;
        return;
      }

      // Insert reservation
      const { error } = await supabase.from("Reservations").insert({
        truck_id, user_id: userId, start_time: start, end_time: end
      });
      if (error) {
        message.innerText = "Reservation failed.";
        console.error("Insert failed:", error);
      } else {
        message.innerText = "âœ… Truck reserved!";
        loadCalendarTable();
        loadFullCalendar();
      }
    }

    // Populate reservation table
    async function loadCalendarTable() {
      const { data: { session } } = await supabase.auth.getSession();
      const userId = session?.user?.id;
      const table = document.getElementById("calendarBody");

      const { data, error } = await supabase
        .from("Reservations")
        .select("*, Trucks(name)")
        .eq("user_id", userId)
        .order("start_time", { ascending: true });

      if (error) {
        console.error("Table load error:", error);
        return;
      }

      table.innerHTML = data.map(res => `
        <tr>
          <td>${res.Trucks.name}</td>
          <td>${new Date(res.start_time).toLocaleString()}</td>
          <td>${new Date(res.end_time).toLocaleString()}</td>
        </tr>
      `).join("");
    }

    // Calendar view
    async function loadFullCalendar() {
      const { data: { session } } = await supabase.auth.getSession();
      const userId = session?.user?.id;

      const { data, error } = await supabase
        .from("Reservations")
        .select("*, Trucks(name)")
        .eq("user_id", userId);

      if (error) {
        console.error("Calendar load error:", error);
        return;
      }

      const events = data.map(res => ({
        title: `${res.Trucks.name}`,
        start: res.start_time,
        end: res.end_time
      }));

      const calendarEl = document.getElementById("calendar");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "timeGridWeek",
        height: "auto",
        events,
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        }
      });
      calendar.render();
    }

    function logout() {
      localStorage.clear();
      supabase.auth.signOut();
      window.location.href = "index.html";
    }

    // Initialize
    loadTrucks();
    loadCalendarTable();
    loadFullCalendar();
  </script>
</body>
</html>


