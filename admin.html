<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Gradex</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://unpkg.com/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ✅ Initialize Supabase only once
    const supabase = window.supabase.createClient(
      "https://nmbapqhtmjsqwdefewfd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tYmFwcWh0bWpzcXdkZWZld2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MTM3MzksImV4cCI6MjA2OTM4OTczOX0.TJmTwXT29jnbtu4Y4QvL0dlUsFFuOPiWsD7BzSOPUfM",
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      }
    );

    // ✅ Ensure only admins can view this page
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = "index.html";
        return;
      }

      const { data: profile, error } = await supabase
        .from("profiles")
        .select("user_type")
        .eq("id", session.user.id)
        .maybeSingle();

      if (error || !profile || profile.user_type !== "admin") {
        console.warn("Access denied, redirecting...");
        window.location.href = "homepage.html";
        return;
      }

      console.log("Signed in as admin:", session.user.email);
      document.getElementById("admin-email").innerText = session.user.email;

      // Load all data after confirming admin
      loadUsers();
      loadTrucks();
      loadReservations();
    })();
  </script>
</head>

<body>
  <header>
    <h1>Gradex Admin Dashboard</h1>
    <div class="admin-header">
      <p>Signed in as: <span id="admin-email"></span></p>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <main>
    <div class="tab-container">
      <button class="tab-btn" onclick="showTab('users')">Users</button>
      <button class="tab-btn" onclick="showTab('trucks')">Trucks</button>
      <button class="tab-btn" onclick="showTab('reservations')">Reservations</button>
    </div>

    <section id="users" class="tab-content active">
      <h2>Users</h2>
      <table>
        <thead>
          <tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>
        </thead>
        <tbody id="userTableBody"></tbody>
      </table>
    </section>

    <section id="trucks" class="tab-content">
      <h2>Manage Trucks</h2>
      <input type="text" id="newTruckName" placeholder="Truck Name" />
      <button onclick="addTruck()">Add Truck</button>
      <p id="truckMessage"></p>
      <table>
        <thead>
          <tr><th>ID</th><th>Name</th><th>Action</th></tr>
        </thead>
        <tbody id="truckTableBody"></tbody>
      </table>
    </section>

    <section id="reservations" class="tab-content">
      <h2>All Reservations</h2>
      <table>
        <thead>
          <tr><th>User</th><th>Truck</th><th>Start</th><th>End</th><th>Action</th></tr>
        </thead>
        <tbody id="reservationTableBody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // ✅ Tabs
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    // ✅ Logout function must be global
    async function logout() {
      await supabase.auth.signOut();
      localStorage.clear();
      window.location.href = "index.html";
    }

    // ✅ Load all users
    async function loadUsers() {
      const { data, error } = await supabase.from("profiles").select("id, name, user_type");
      if (error) {
        console.error("Error loading users:", error);
        return;
      }

      const table = document.getElementById("userTableBody");
      table.innerHTML = data.map(u => `
        <tr>
          <td>${u.name}</td>
          <td>${u.id}</td>
          <td>${u.user_type}</td>
          <td>
            ${u.user_type !== 'admin'
              ? `<button onclick="makeAdmin('${u.id}')">Make Admin</button>`
              : '<em>Admin</em>'}
          </td>
        </tr>
      `).join("");
    }

    // ✅ Promote user to admin
    async function makeAdmin(userId) {
      const { error } = await supabase
        .from("profiles")
        .update({ user_type: "admin" })
        .eq("id", userId);
      if (error) {
        alert("Error updating user: " + error.message);
        return;
      }
      alert("User promoted to admin.");
      loadUsers();
    }

    // ✅ Load trucks
    async function loadTrucks() {
      const { data, error } = await supabase.from("Trucks").select("*");
      const table = document.getElementById("truckTableBody");
      if (error) {
        console.error("Truck load error:", error);
        return;
      }

      table.innerHTML = data.map(t => `
        <tr>
          <td>${t.id}</td>
          <td>${t.name}</td>
          <td><button onclick="deleteTruck('${t.id}')">Delete</button></td>
        </tr>
      `).join("");
    }

    // ✅ Add truck
    async function addTruck() {
      const name = document.getElementById("newTruckName").value.trim();
      const message = document.getElementById("truckMessage");
      if (!name) {
        message.innerText = "Enter a truck name.";
        return;
      }
      const { error } = await supabase.from("Trucks").insert({ name });
      if (error) {
        message.innerText = "Error adding truck.";
        console.error("Truck insert error:", error);
      } else {
        message.innerText = "Truck added!";
        document.getElementById("newTruckName").value = "";
        loadTrucks();
      }
    }

    // ✅ Delete truck
    async function deleteTruck(id) {
      const { error } = await supabase.from("Trucks").delete().eq("id", id);
      if (error) {
        alert("Error deleting truck: " + error.message);
        return;
      }
      alert("Truck deleted.");
      loadTrucks();
    }

    // ✅ Load all reservations
    async function loadReservations() {
      const { data, error } = await supabase
        .from("Reservations")
        .select("id, start_time, end_time, profiles(name), Trucks(name)");

      if (error) {
        console.error("Error loading reservations:", error);
        return;
      }

      const table = document.getElementById("reservationTableBody");
      table.innerHTML = data.map(r => `
        <tr>
          <td>${r.profiles?.name || "Unknown"}</td>
          <td>${r.Trucks?.name || "Unknown"}</td>
          <td>${new Date(r.start_time).toLocaleString()}</td>
          <td>${new Date(r.end_time).toLocaleString()}</td>
          <td><button onclick="cancelReservation('${r.id}')">Cancel</button></td>
        </tr>
      `).join("");
    }

    // ✅ Cancel reservation
    async function cancelReservation(resId) {
      const { error } = await supabase.from("Reservations").delete().eq("id", resId);
      if (error) {
        alert("Error canceling reservation: " + error.message);
        return;
      }
      alert("Reservation canceled.");
      loadReservations();
    }
  </script>
</body>
</html>